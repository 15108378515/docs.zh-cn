---
title: 条件 Get 和 Put
ms.date: 03/30/2017
ms.assetid: 3d22067f-57b8-4e0f-a571-a694512187ae
ms.openlocfilehash: 29819f89327128cdd71cc89eb8d14126522dc2df
ms.sourcegitcommit: 3ab9254890a52a50762995fa6d7d77a00348db7e
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/19/2018
ms.locfileid: "46324406"
---
# <a name="conditional-get-and-put"></a><span data-ttu-id="33adc-102">条件 Get 和 Put</span><span class="sxs-lookup"><span data-stu-id="33adc-102">Conditional Get and Put</span></span>
<span data-ttu-id="33adc-103">此示例演示如何将新条件检索和更新 API 用于 WCF REST 编程模型。</span><span class="sxs-lookup"><span data-stu-id="33adc-103">This sample demonstrates how to use the new conditional retrieve and update APIs for the WCF REST programming model.</span></span> <span data-ttu-id="33adc-104">由于条件检索和更新最适合面向资源的和 REST 服务，此示例扩展[基本资源服务](../../../../docs/framework/wcf/samples/basic-resource-service.md)示例。</span><span class="sxs-lookup"><span data-stu-id="33adc-104">Because conditional retrieve and update are most appropriate for resource-oriented and REST services, this sample extends the [Basic Resource Service](../../../../docs/framework/wcf/samples/basic-resource-service.md) sample.</span></span> <span data-ttu-id="33adc-105">此示例重点介绍添加对条件检索和更新的支持[基本资源服务](../../../../docs/framework/wcf/samples/basic-resource-service.md)示例使用新的 Api 中引入[!INCLUDE[netfx40_long](../../../../includes/netfx40-long-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="33adc-105">This sample focuses on adding support for conditional retrieve and update to the [Basic Resource Service](../../../../docs/framework/wcf/samples/basic-resource-service.md) sample using the new APIs introduced in [!INCLUDE[netfx40_long](../../../../includes/netfx40-long-md.md)].</span></span>  
  
## <a name="demonstrates"></a><span data-ttu-id="33adc-106">演示</span><span class="sxs-lookup"><span data-stu-id="33adc-106">Demonstrates</span></span>  
 <span data-ttu-id="33adc-107">条件检索和更新</span><span class="sxs-lookup"><span data-stu-id="33adc-107">Conditional Retrieve and Update</span></span>  
  
## <a name="discussion"></a><span data-ttu-id="33adc-108">讨论</span><span class="sxs-lookup"><span data-stu-id="33adc-108">Discussion</span></span>  
 <span data-ttu-id="33adc-109">此示例中的 WCF 服务以面向资源和 REST 的方式公开客户集合。</span><span class="sxs-lookup"><span data-stu-id="33adc-109">The WCF service in this sample exposes a collection of customers in a resource-oriented and REST manner.</span></span> <span data-ttu-id="33adc-110">有关服务实现的详细说明，请参阅[基本资源服务](../../../../docs/framework/wcf/samples/basic-resource-service.md)示例。</span><span class="sxs-lookup"><span data-stu-id="33adc-110">For a detailed description of the service implementation, please see the [Basic Resource Service](../../../../docs/framework/wcf/samples/basic-resource-service.md) sample.</span></span>  
  
 <span data-ttu-id="33adc-111">此示例添加了条件检索和更新功能[基本资源服务](../../../../docs/framework/wcf/samples/basic-resource-service.md)示例。</span><span class="sxs-lookup"><span data-stu-id="33adc-111">This sample adds conditional retrieve and update capabilities to the [Basic Resource Service](../../../../docs/framework/wcf/samples/basic-resource-service.md) sample.</span></span> <span data-ttu-id="33adc-112">条件检索和更新使用 HTTP 实体标记以及 HTTP If-None-Match 和 If-Match 标头来验证客户端是否具有给定资源的最新实体。</span><span class="sxs-lookup"><span data-stu-id="33adc-112">Conditional retrieve and update use HTTP entity tags and the HTTP If-None-Match and If-Match headers to validate that clients either have or do not have the most current entity for a given resource.</span></span> <span data-ttu-id="33adc-113">但是，为了正确分析 HTTP If-None-Match 和 If-Match 标头而实现该代码可能单调乏味并且容易出错。</span><span class="sxs-lookup"><span data-stu-id="33adc-113">However, implementing the code to correctly parse the HTTP If-None-Match and If-Match headers can be tedious and error-prone.</span></span> <span data-ttu-id="33adc-114">因此，<xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> 和 <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalUpdate%2A> 方法已添加到 <xref:System.ServiceModel.Web.IncomingWebRequestContext>（可使用 <xref:System.ServiceModel.Web.WebOperationContext> 的当前实例来访问）。</span><span class="sxs-lookup"><span data-stu-id="33adc-114">Therefore, the <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> and <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalUpdate%2A> methods have been added to the <xref:System.ServiceModel.Web.IncomingWebRequestContext>, which can be accessed using the current instance of the <xref:System.ServiceModel.Web.WebOperationContext>.</span></span> <span data-ttu-id="33adc-115">此外，`SetETag` 方法也已添加到 <xref:System.ServiceModel.Web.OutgoingWebRequestContext>，这使得返回有效的实体标记更为容易。</span><span class="sxs-lookup"><span data-stu-id="33adc-115">In addition, the `SetETag` method has been added to the <xref:System.ServiceModel.Web.OutgoingWebRequestContext>, making it easier to return valid entity tags.</span></span>  
  
 <span data-ttu-id="33adc-116"><xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> 方法旨在与 [WebGet] 操作一起使用。</span><span class="sxs-lookup"><span data-stu-id="33adc-116">The <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> method is intended to be used with [WebGet] operations.</span></span> <span data-ttu-id="33adc-117">它将给定资源的当前实体视为 `entityTag` 参数，该参数可以是 `string`、`int`、`long` 或 `Guid`。</span><span class="sxs-lookup"><span data-stu-id="33adc-117">It takes the current entity tag for the given resource as the `entityTag` parameter, which can be a `string`, `int`, `long` or `Guid`.</span></span> <span data-ttu-id="33adc-118"><xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> 方法针对请求的 HTTP If-None-Match 标头来检查实体标记。</span><span class="sxs-lookup"><span data-stu-id="33adc-118">The <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> method checks the entity tag against the HTTP If-None-Match header of the request.</span></span> <span data-ttu-id="33adc-119">如果 HTTP If-None-Match 标头中存在该实体标记，则将引发状态代码为 304（未修改）的 <xref:System.ServiceModel.Web.WebFaultException>，否则该方法返回。</span><span class="sxs-lookup"><span data-stu-id="33adc-119">If the entity tag is present in the HTTP If-None-Match header, then a <xref:System.ServiceModel.Web.WebFaultException> with a status code of Not Modified (304) is thrown; otherwise the method returns.</span></span> <span data-ttu-id="33adc-120">通过条件检索机制，客户端可以通知服务器它拥有此实体，并且只有在该客户端尚没有当前实体时才发送该实体。</span><span class="sxs-lookup"><span data-stu-id="33adc-120">The conditional retrieve mechanism allows the client to tell the server that it has this entity and to only send the current entity if the client does not already have it.</span></span> <span data-ttu-id="33adc-121"><xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> 方法的示例用法可以在该服务的 `GetCustomer` 和 `GetCustomers` 操作中看到。</span><span class="sxs-lookup"><span data-stu-id="33adc-121">Example usage of the <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> method can be seen in the `GetCustomer` and `GetCustomers` operations of the service.</span></span> <span data-ttu-id="33adc-122">需要特别注意的是，对 <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> 的调用可能不会返回。</span><span class="sxs-lookup"><span data-stu-id="33adc-122">It is important to note that calls to <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> may not return.</span></span> <span data-ttu-id="33adc-123">开发人员应实现该操作，以便在执行对 <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> 的调用之前已经知道请求成功，因此，如果对 <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> 的调用不存在，则该服务将使用成功的状态代码来发送响应。</span><span class="sxs-lookup"><span data-stu-id="33adc-123">Developers should implement the operation so that the request is already known to be successful before the call to <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> is executed, such that if the call to <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> was not present, the service would send a response with a successful status code.</span></span>  
  
 <span data-ttu-id="33adc-124"><xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalUpdate%2A> 方法类似于 <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> 方法。</span><span class="sxs-lookup"><span data-stu-id="33adc-124">The <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalUpdate%2A> method is similar to the <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> method.</span></span> <span data-ttu-id="33adc-125">它还将使用给定资源的当前实体标记。</span><span class="sxs-lookup"><span data-stu-id="33adc-125">It also takes the current entity tag for the given resource.</span></span> <span data-ttu-id="33adc-126">但是，它旨在与在其中的方法设置为"PUT"或"删除"的 [WebInvoke] 操作一起使用。</span><span class="sxs-lookup"><span data-stu-id="33adc-126">However, it is intended to be used with [WebInvoke] operations in which the method is set to "PUT" or "DELETE".</span></span> <span data-ttu-id="33adc-127"><xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalUpdate%2A> 方法针对请求的 HTTP If-Match 标头来检查该实体标记。</span><span class="sxs-lookup"><span data-stu-id="33adc-127">The <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalUpdate%2A> method checks the entity tag against the HTTP If-Match header of the request.</span></span> <span data-ttu-id="33adc-128">如果 HTTP If-Match 标头中不存在该实体标记，则将引发状态代码为 412（前提条件失败）的 <xref:System.ServiceModel.Web.WebFaultException>。</span><span class="sxs-lookup"><span data-stu-id="33adc-128">If the entity tag is not present in the HTTP If-Match header, then a <xref:System.ServiceModel.Web.WebFaultException> with a status code of Precondition Failed (412) is thrown.</span></span> <span data-ttu-id="33adc-129">通过条件更新机制，客户端可以通知服务器它拥有该资源的实体，并且只允许客户端更改该资源（如果它所拥有的实体为当前实体）。</span><span class="sxs-lookup"><span data-stu-id="33adc-129">The conditional update mechanism allows the client to tell the server that it has this entity for the resource and to only allow the client to alter the resource; if the entity it has is current.</span></span> <span data-ttu-id="33adc-130"><xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalUpdate%2A> 方法的示例用法可以在该服务的 `UpdateCustomer` 和 `DeleteCustomer` 操作中看到。</span><span class="sxs-lookup"><span data-stu-id="33adc-130">Example usage of the <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalUpdate%2A> method can be seen in the `UpdateCustomer` and `DeleteCustomer` operations of the service.</span></span> <span data-ttu-id="33adc-131">就像在 <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A> 中那样，需要特别注意的是，对 <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalUpdate%2A> 的调用可能不会返回。</span><span class="sxs-lookup"><span data-stu-id="33adc-131">Just as with <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalRetrieve%2A>, it is important to note that calls to <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalUpdate%2A> may not return.</span></span> <span data-ttu-id="33adc-132">开发人员应实现该操作，以便在执行对 <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalUpdate%2A> 的调用之前已经知道请求成功，因此，如果对 <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalUpdate%2A> 的调用不存在，则该服务将使用成功状态代码加以响应。</span><span class="sxs-lookup"><span data-stu-id="33adc-132">Developers should implement the operation such that the request is already known to be successful before the call to <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalUpdate%2A> is executed, such that if the call to <xref:System.ServiceModel.Web.IncomingWebRequestContext.CheckConditionalUpdate%2A> was not present, the service would respond with a successful status code.</span></span>  
  
 <span data-ttu-id="33adc-133">此示例包含一个自承载服务和一个客户端，它们都在一个控制台应用程序内运行。</span><span class="sxs-lookup"><span data-stu-id="33adc-133">The sample consists of a self-hosted service and a client that runs within a console application.</span></span> <span data-ttu-id="33adc-134">在控制台应用程序运行时，客户端会对服务进行请求，并将响应中的相关信息写入控制台窗口。</span><span class="sxs-lookup"><span data-stu-id="33adc-134">As the console application runs, the client makes requests to the service and writes the pertinent information from the responses to the console window.</span></span>  
  
#### <a name="to-run-the-sample"></a><span data-ttu-id="33adc-135">运行示例</span><span class="sxs-lookup"><span data-stu-id="33adc-135">To run the sample</span></span>  
  
1.  <span data-ttu-id="33adc-136">打开条件 Get 和 Put 示例的解决方案。</span><span class="sxs-lookup"><span data-stu-id="33adc-136">Open the solution for the Conditional Get and Put sample.</span></span> <span data-ttu-id="33adc-137">在启动 [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] 时，必须以管理员身份运行才能成功执行示例。</span><span class="sxs-lookup"><span data-stu-id="33adc-137">When launching [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)], you must run as an administrator to execute the sample successfully.</span></span> <span data-ttu-id="33adc-138">执行此操作，请右键单击[!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)]图标并选择**以管理员身份运行**从上下文菜单。</span><span class="sxs-lookup"><span data-stu-id="33adc-138">Do this by right-clicking the [!INCLUDE[vs_current_long](../../../../includes/vs-current-long-md.md)] icon and choosing **Run as Administrator** from the context menu.</span></span>  
  
2.  <span data-ttu-id="33adc-139">按 Ctrl+Shift+B 生成解决方案，然后按 Ctrl+F5 运行控制台应用程序项目。</span><span class="sxs-lookup"><span data-stu-id="33adc-139">Press CTRL+SHIFT+B to build the solution and then press CTRL+F5 to run the console application project.</span></span> <span data-ttu-id="33adc-140">如果在启用调试的情况下运行此项目（按 F5 而不是 Ctrl+F5），则在条件 GET 和 PUT 检查引发异常时，调试器将停止。</span><span class="sxs-lookup"><span data-stu-id="33adc-140">If running this project with debugging enabled (by pressing F5 instead of CTRL+F5), the debugger stops when an exception is thrown by the conditional GET and PUT checking.</span></span> <span data-ttu-id="33adc-141">发生这种情况时，按 F5 可继续执行示例。</span><span class="sxs-lookup"><span data-stu-id="33adc-141">When this happens, press F5 to continue executing the sample.</span></span>  
  
3.  <span data-ttu-id="33adc-142">将出现控制台窗口，它提供了正在运行的服务的 URI，以及该服务的 HTML 帮助页的 URI。</span><span class="sxs-lookup"><span data-stu-id="33adc-142">The console window appear sand provides the URI of the running service and the URI of the HTML help page for the running service.</span></span>  
  
4.  <span data-ttu-id="33adc-143">在示例运行时，客户端会向服务发送请求，并将响应写入控制台窗口。</span><span class="sxs-lookup"><span data-stu-id="33adc-143">As the sample runs, the client sends requests to the service and writes the responses to the console window.</span></span>  
  
5.  <span data-ttu-id="33adc-144">按任何键可终止示例。</span><span class="sxs-lookup"><span data-stu-id="33adc-144">Press any key to terminate the sample.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="33adc-145">您的计算机上可能已安装这些示例。</span><span class="sxs-lookup"><span data-stu-id="33adc-145">The samples may already be installed on your machine.</span></span> <span data-ttu-id="33adc-146">在继续操作之前，请先检查以下（默认）目录：</span><span class="sxs-lookup"><span data-stu-id="33adc-146">Check for the following (default) directory before continuing.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples`  
>   
>  <span data-ttu-id="33adc-147">如果此目录不存在，请转到[Windows Communication Foundation (WCF) 和.NET Framework 4 的 Windows Workflow Foundation (WF) 示例](https://go.microsoft.com/fwlink/?LinkId=150780)若要下载所有 Windows Communication Foundation (WCF) 和[!INCLUDE[wf1](../../../../includes/wf1-md.md)]示例。</span><span class="sxs-lookup"><span data-stu-id="33adc-147">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="33adc-148">此示例位于以下目录：</span><span class="sxs-lookup"><span data-stu-id="33adc-148">This sample is located in the following directory.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples\WCF\Basic\Web\ConditionalGetAndPut`
