---
title: 服务内的 TransactionScope 嵌套
ms.date: 03/30/2017
ms.assetid: e7e1ba64-1384-4eba-add8-415636e2d6d0
ms.openlocfilehash: cf73c0c2d061f1c997a8ade5d7b2bf61887915ca
ms.sourcegitcommit: a885cc8c3e444ca6471348893d5373c6e9e49a47
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/07/2018
ms.locfileid: "44067245"
---
# <a name="nesting-of-transactionscope-within-a-service"></a><span data-ttu-id="675d1-102">服务内的 TransactionScope 嵌套</span><span class="sxs-lookup"><span data-stu-id="675d1-102">Nesting of TransactionScope within a service</span></span>
<span data-ttu-id="675d1-103">此示例包含两个演示如何在一个服务中处理 <xref:System.Activities.Statements.TransactionScope> 活动实例的方案。</span><span class="sxs-lookup"><span data-stu-id="675d1-103">This sample consists of two scenarios that run showing how to handle <xref:System.Activities.Statements.TransactionScope> activity instances within a service.</span></span> <span data-ttu-id="675d1-104">首先使用 <xref:System.Activities.Statements.TransactionScope> 活动发起事务，以在客户端上创建一个新的事务和要接收的 <xref:System.ServiceModel.Activities.TransactedReceiveScope>，并确定事务在服务器上的生存期范围。</span><span class="sxs-lookup"><span data-stu-id="675d1-104">First the transaction is initiated using the <xref:System.Activities.Statements.TransactionScope> activity to create a new transaction on the client and <xref:System.ServiceModel.Activities.TransactedReceiveScope> to receive and scope the lifetime of the transaction on the server.</span></span> <span data-ttu-id="675d1-105">该服务内的第一个方案运行一个辅助 <xref:System.Activities.Statements.TransactionScope> 活动，以演示服务中的 <xref:System.Activities.Statements.TransactionScope> 活动的嵌套。</span><span class="sxs-lookup"><span data-stu-id="675d1-105">The first scenario within the service runs a secondary <xref:System.Activities.Statements.TransactionScope> activity to demonstrate the nesting of the <xref:System.Activities.Statements.TransactionScope> activities within the service.</span></span> <span data-ttu-id="675d1-106">第二个方案演示如何在嵌套的 <xref:System.Activities.Statements.TransactionScope> 活动中遵循超时限制。</span><span class="sxs-lookup"><span data-stu-id="675d1-106">The second scenario shows how time-outs are respected within the nested <xref:System.Activities.Statements.TransactionScope> activities.</span></span>  
  
## <a name="client-application"></a><span data-ttu-id="675d1-107">客户端应用程序</span><span class="sxs-lookup"><span data-stu-id="675d1-107">Client Application</span></span>  
 <span data-ttu-id="675d1-108">客户端应用程序运行一个工作流，该工作流启动一个 <xref:System.Activities.Statements.TransactionScope> 活动，输出分布式事务 ID，向服务器发送消息，流动事务，接收回复，再次输出分布式事务 ID 并完成操作。</span><span class="sxs-lookup"><span data-stu-id="675d1-108">The client application runs a workflow that starts a <xref:System.Activities.Statements.TransactionScope> activity, prints the distributed transaction ID, sends a message to the server, flows the transaction, receives the reply, prints the distributed transaction ID again and completes.</span></span> <span data-ttu-id="675d1-109">它对每个服务方案执行一次这样的操作。</span><span class="sxs-lookup"><span data-stu-id="675d1-109">It does this once for each service scenario.</span></span>  
  
## <a name="server-application"></a><span data-ttu-id="675d1-110">服务器应用程序</span><span class="sxs-lookup"><span data-stu-id="675d1-110">Server Application</span></span>  
 <span data-ttu-id="675d1-111">服务器项目承载于 <xref:System.ServiceModel.Activities.WorkflowServiceHost> 中，后者可创建用于侦听来自客户端的消息的终结点。</span><span class="sxs-lookup"><span data-stu-id="675d1-111">The server project is hosted in <xref:System.ServiceModel.Activities.WorkflowServiceHost>, which creates the endpoint to listen for the message from the client.</span></span> <span data-ttu-id="675d1-112">工作流位于 <xref:System.ServiceModel.Activities.TransactedReceiveScope> 的中心，后者从客户端接收流动的事务，输出分布式事务 ID，然后再次执行 <xref:System.Activities.Statements.TransactionScope> 活动。</span><span class="sxs-lookup"><span data-stu-id="675d1-112">The workflow is centered on the <xref:System.ServiceModel.Activities.TransactedReceiveScope>, which receives the flowed transaction from the client, prints the distributed transaction ID and then executes a second <xref:System.Activities.Statements.TransactionScope> activity.</span></span> <span data-ttu-id="675d1-113">在第一个方案中，事务成功完成。</span><span class="sxs-lookup"><span data-stu-id="675d1-113">In the first scenario, the transaction is completed successfully.</span></span> <span data-ttu-id="675d1-114">在第二个方案中，<xref:System.Activities.Statements.TransactionScope> 活动的主体是 5 秒延迟，事务的超时设置为 2 秒。</span><span class="sxs-lookup"><span data-stu-id="675d1-114">In the second scenario, the body of the <xref:System.Activities.Statements.TransactionScope> activity is a five-second delay and the time-out for the transaction is set to two seconds.</span></span> <span data-ttu-id="675d1-115">当事务超时时，事务将会中止。</span><span class="sxs-lookup"><span data-stu-id="675d1-115">When the transaction times out the transaction is aborted.</span></span>  
  
#### <a name="to-run-the-sample"></a><span data-ttu-id="675d1-116">运行示例</span><span class="sxs-lookup"><span data-stu-id="675d1-116">To run the sample</span></span>  
  
1.  <span data-ttu-id="675d1-117">在 [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)] 中打开 TransactionServiceExample.sln 解决方案。</span><span class="sxs-lookup"><span data-stu-id="675d1-117">Open the TransactionServiceExample.sln solution in [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)].</span></span>  
  
2.  <span data-ttu-id="675d1-118">若要生成解决方案，请按 CTRL + SHIFT + B 或选择**生成解决方案**从**生成**菜单。</span><span class="sxs-lookup"><span data-stu-id="675d1-118">To build the solution, press CTRL+SHIFT+B or select **Build Solution** from the **Build** menu.</span></span>  
  
3.  <span data-ttu-id="675d1-119">成功生成之后，右键单击解决方案并选择**设置启动项目**。</span><span class="sxs-lookup"><span data-stu-id="675d1-119">Once the build has succeeded, right-click the solution and select **Set Startup Projects**.</span></span> <span data-ttu-id="675d1-120">从对话框中，选择**多个启动项目**，并确保这两个项目的操作是**启动**。</span><span class="sxs-lookup"><span data-stu-id="675d1-120">From the dialog box, select **Multiple Startup Projects** and ensure the action for both projects is **Start**.</span></span>  
  
4.  <span data-ttu-id="675d1-121">按 F5 或选择**开始调试**从**调试**菜单。</span><span class="sxs-lookup"><span data-stu-id="675d1-121">Press F5 or select **Start Debugging** from the **Debug** menu.</span></span> <span data-ttu-id="675d1-122">或者，可以按 CTRL + F5 或选择**启动但不调试**从**调试**菜单运行而不进行调试。</span><span class="sxs-lookup"><span data-stu-id="675d1-122">Alternatively, you can press CTRL+F5 or select **Start Without Debugging** from the **Debug** menu to run without debugging.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="675d1-123">您的计算机上可能已安装这些示例。</span><span class="sxs-lookup"><span data-stu-id="675d1-123">The samples may already be installed on your machine.</span></span> <span data-ttu-id="675d1-124">在继续操作之前，请先检查以下（默认）目录：</span><span class="sxs-lookup"><span data-stu-id="675d1-124">Check for the following (default) directory before continuing.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples`  
>   
>  <span data-ttu-id="675d1-125">如果此目录不存在，请转到[Windows Communication Foundation (WCF) 和.NET Framework 4 的 Windows Workflow Foundation (WF) 示例](https://go.microsoft.com/fwlink/?LinkId=150780)若要下载所有 Windows Communication Foundation (WCF) 和[!INCLUDE[wf1](../../../../includes/wf1-md.md)]示例。</span><span class="sxs-lookup"><span data-stu-id="675d1-125">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="675d1-126">此示例位于以下目录：</span><span class="sxs-lookup"><span data-stu-id="675d1-126">This sample is located in the following directory.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples\WF\Basic\Transactions\TRSComposability`
