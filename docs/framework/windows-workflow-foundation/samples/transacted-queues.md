---
title: 事务处理队列
ms.date: 03/30/2017
ms.assetid: b1b011dd-5e0b-482c-9bb0-9d8727038f14
ms.openlocfilehash: db6a9686334eefb02b9360827a23ca8363127eb5
ms.sourcegitcommit: a885cc8c3e444ca6471348893d5373c6e9e49a47
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/06/2018
ms.locfileid: "44048024"
---
# <a name="transacted-queues"></a><span data-ttu-id="b3119-102">事务处理队列</span><span class="sxs-lookup"><span data-stu-id="b3119-102">Transacted Queues</span></span>
<span data-ttu-id="b3119-103">此示例演示如何将队列和事务中 Windows Workflow Foundation (WF) 来创建可靠且可伸缩的服务进行集成。</span><span class="sxs-lookup"><span data-stu-id="b3119-103">This sample shows how to integrate queues and transactions in Windows Workflow Foundation (WF) to create reliable and scalable services.</span></span> <span data-ttu-id="b3119-104">一个<!--zz <xref:System.Activities.TransactionScope>-->`System.Activities.TransactionScope`客户端工作流中用于将消息发送到队列中事务使用<xref:System.ServiceModel.NetMsmqBinding>。</span><span class="sxs-lookup"><span data-stu-id="b3119-104">A <!--zz <xref:System.Activities.TransactionScope>--> `System.Activities.TransactionScope` is used in the client workflow to send message to a queue under a transaction using the <xref:System.ServiceModel.NetMsmqBinding>.</span></span> <span data-ttu-id="b3119-105">在服务器上使用 <xref:System.ServiceModel.Activities.TransactedReceiveScope>，在同一个事务中从队列接受消息并更新工作流的状态。</span><span class="sxs-lookup"><span data-stu-id="b3119-105">A <xref:System.ServiceModel.Activities.TransactedReceiveScope> is used on the server to receive messages from the queue and update the state of the workflow under the same transaction.</span></span>  
  
## <a name="demonstrates"></a><span data-ttu-id="b3119-106">演示</span><span class="sxs-lookup"><span data-stu-id="b3119-106">Demonstrates</span></span>  
 <span data-ttu-id="b3119-107"><xref:System.Activities.Statements.TransactionScope>、<xref:System.ServiceModel.Activities.TransactedReceiveScope>、<xref:System.ServiceModel.NetMsmqBinding>、<xref:System.ServiceModel.Activities.Receive> 和基于内容的相关性。</span><span class="sxs-lookup"><span data-stu-id="b3119-107"><xref:System.Activities.Statements.TransactionScope>, <xref:System.ServiceModel.Activities.TransactedReceiveScope>, <xref:System.ServiceModel.NetMsmqBinding>, <xref:System.ServiceModel.Activities.Receive>, and content-based correlation.</span></span>  
  
## <a name="discussion"></a><span data-ttu-id="b3119-108">讨论</span><span class="sxs-lookup"><span data-stu-id="b3119-108">Discussion</span></span>  
 <span data-ttu-id="b3119-109">为了演示此示例中涉及的功能，将创建一个 `RewardsPoints` 工作流服务，该服务跟踪为给定帐户赚取和使用的点数。</span><span class="sxs-lookup"><span data-stu-id="b3119-109">To demonstrate the features covered in this sample, a `RewardsPoints` workflow service is created, which keeps track of the points earned and used for a given account.</span></span> <span data-ttu-id="b3119-110">客户端使用 <xref:System.Activities.WorkflowInvoker> 来模拟向队列发送各种请求。</span><span class="sxs-lookup"><span data-stu-id="b3119-110">The client uses <xref:System.Activities.WorkflowInvoker> to simulate posting various requests to the queue.</span></span> <span data-ttu-id="b3119-111">若要在一个事务中将消息发送到队列中，可以将 <xref:System.ServiceModel.Activities.Send> 活动放在 <xref:System.Activities.Statements.TransactionScope.Body%2A> 的 <xref:System.Activities.Statements.TransactionScope> 的内部。</span><span class="sxs-lookup"><span data-stu-id="b3119-111">To post a message to the queue under a transaction, the <xref:System.ServiceModel.Activities.Send> activity can be placed inside the <xref:System.Activities.Statements.TransactionScope.Body%2A> of a <xref:System.Activities.Statements.TransactionScope>.</span></span> <span data-ttu-id="b3119-112">在此示例中，首先运行客户端，然后运行服务器，演示队列消息如何分离客户和服务器应用程序。</span><span class="sxs-lookup"><span data-stu-id="b3119-112">In this sample, the client runs first, followed by the server, to demonstrate how queued messages can decouple the client and server applications.</span></span>  
  
 <span data-ttu-id="b3119-113">在客户端完成之后，将配置并承载服务。</span><span class="sxs-lookup"><span data-stu-id="b3119-113">Once the client completes, the service is configured and hosted.</span></span> <span data-ttu-id="b3119-114">一旦服务打开，它便会开始处理已放置在队列中的消息。</span><span class="sxs-lookup"><span data-stu-id="b3119-114">As soon as it opens, it starts processing the messages that have already been placed in the queue.</span></span> <span data-ttu-id="b3119-115">在同一个服务器事务中接收和处理每条消息。</span><span class="sxs-lookup"><span data-stu-id="b3119-115">Each message is received and processed under the same server transaction.</span></span> <span data-ttu-id="b3119-116">在此示例中，接收的第一条消息是一个 `CreateAccount` 请求，该请求根据作为请求消息的一部分传递的帐户名，创建实例并初始化内容相关性。</span><span class="sxs-lookup"><span data-stu-id="b3119-116">In this sample, the first message received is a `CreateAccount` request that creates the instance and initializes the content correlation based on the account name passed as part of the request message.</span></span> <span data-ttu-id="b3119-117">为了模拟现实世界中可能需要的服务类型，在 <xref:System.ServiceModel.Activities.TransactedReceiveScope> 循环内的平行分支中放置两个 `AddPoints` 活动（分别用于处理 `UsePoints` 和 `while` 消息），以便这两个活动可以按任意顺序重复处理这些消息。</span><span class="sxs-lookup"><span data-stu-id="b3119-117">To model the kind of service you might expect in the real world, the following two <xref:System.ServiceModel.Activities.TransactedReceiveScope> activities that process the `AddPoints` and `UsePoints` messages are placed in parallel branches within a `while` loop so that they can process these messages repeatedly in any order.</span></span>  
  
 <span data-ttu-id="b3119-118"><xref:System.Activities.Statements.TransactionScope> 和 <xref:System.ServiceModel.Activities.TransactedReceiveScope> 在其范围的结尾都有一个隐式的持久性点。因此，通过在 [!INCLUDE[wf1](../../../../includes/wf1-md.md)] 中将这些活动与队列组合使用，可以将工作流从一个一致状态可靠地移动到下一个一致状态，同时确保消息绝不丢失。</span><span class="sxs-lookup"><span data-stu-id="b3119-118"><xref:System.Activities.Statements.TransactionScope> and <xref:System.ServiceModel.Activities.TransactedReceiveScope> each have an implicit persistence point at the end of their scopes, so using these activities in [!INCLUDE[wf1](../../../../includes/wf1-md.md)] combined with queues is a reliable way to move your workflow from one consistent state to the next, while ensuring that messages are never lost.</span></span>  
  
#### <a name="to-set-up-build-and-run-the-sample"></a><span data-ttu-id="b3119-119">设置、生成和运行示例</span><span class="sxs-lookup"><span data-stu-id="b3119-119">To set up, build, and run the sample</span></span>  
  
1.  <span data-ttu-id="b3119-120">安装和配置 MSMQ。</span><span class="sxs-lookup"><span data-stu-id="b3119-120">Install and configure MSMQ.</span></span> <span data-ttu-id="b3119-121">请参阅[安装消息队列](https://go.microsoft.com/fwlink/?LinkId=178526)有关详细信息。</span><span class="sxs-lookup"><span data-stu-id="b3119-121">See [Installing Message Queuing](https://go.microsoft.com/fwlink/?LinkId=178526) for details.</span></span>  
  
2.  <span data-ttu-id="b3119-122">通过在命令行上执行以下命令来确保 MSDTC 正在运行：</span><span class="sxs-lookup"><span data-stu-id="b3119-122">Ensure that MSDTC is running by executing the following command on a command line.</span></span> `net start msdtc`  
  
3.  <span data-ttu-id="b3119-123">编译项目并打开可执行文件，或在 [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)] 中打开项目并从“调试”菜单中选择一个启动选项。</span><span class="sxs-lookup"><span data-stu-id="b3119-123">Compile the project and open the executable, or open the project in [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)] and select a start option from the debug menu.</span></span> <span data-ttu-id="b3119-124">首先，创建队列，然后运行客户端并将消息发送到队列，最后启动服务并处理消息。</span><span class="sxs-lookup"><span data-stu-id="b3119-124">First, the queue is created, then the client runs and posts messages to the queue, and finally the service starts and the messages are processed.</span></span> <span data-ttu-id="b3119-125">按 Enter 退出程序。</span><span class="sxs-lookup"><span data-stu-id="b3119-125">To exit the program, press ENTER.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="b3119-126">您的计算机上可能已安装这些示例。</span><span class="sxs-lookup"><span data-stu-id="b3119-126">The samples may already be installed on your machine.</span></span> <span data-ttu-id="b3119-127">在继续操作之前，请先检查以下（默认）目录：</span><span class="sxs-lookup"><span data-stu-id="b3119-127">Check for the following (default) directory before continuing.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples`  
>   
>  <span data-ttu-id="b3119-128">如果此目录不存在，请转到[Windows Communication Foundation (WCF) 和.NET Framework 4 的 Windows Workflow Foundation (WF) 示例](https://go.microsoft.com/fwlink/?LinkId=150780)若要下载所有 Windows Communication Foundation (WCF) 和[!INCLUDE[wf1](../../../../includes/wf1-md.md)]示例。</span><span class="sxs-lookup"><span data-stu-id="b3119-128">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="b3119-129">此示例位于以下目录：</span><span class="sxs-lookup"><span data-stu-id="b3119-129">This sample is located in the following directory.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples\WF\Scenario\Transactions\TransactedQueues`
