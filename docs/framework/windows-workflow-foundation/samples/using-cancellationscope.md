---
title: 使用 CancellationScope
ms.date: 03/30/2017
ms.assetid: 39c5c338-b316-43d6-b7fe-a543281dd1ec
ms.openlocfilehash: 82d44fff869f207c09dc7685fc3470630e001a59
ms.sourcegitcommit: a885cc8c3e444ca6471348893d5373c6e9e49a47
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/06/2018
ms.locfileid: "44035760"
---
# <a name="using-cancellationscope"></a><span data-ttu-id="ea1fd-102">使用 CancellationScope</span><span class="sxs-lookup"><span data-stu-id="ea1fd-102">Using CancellationScope</span></span>
<span data-ttu-id="ea1fd-103">此示例演示如何使用 <xref:System.Activities.Statements.CancellationScope> 活动取消应用程序中的工作。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-103">This sample demonstrates how to use the <xref:System.Activities.Statements.CancellationScope> activity to cancel work in an application.</span></span>  
  
 <span data-ttu-id="ea1fd-104">许多中间层组件和服务依靠已知的事务编程构造来处理针对它们的取消操作。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-104">Many middle tier components and services rely on the well-known programming construct of transactions to handle cancellation for them.</span></span>  <span data-ttu-id="ea1fd-105">但在许多情况下，必须取消事务中无法执行的工作。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-105">However, there are many situations in which work that cannot be done in a transaction must be canceled.</span></span>  <span data-ttu-id="ea1fd-106">使用取消的难度大于使用事务的难度，这是因为必须先跟踪必须取消的工作。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-106">Using cancellation is more difficult than using transactions, because work that must be canceled must first be tracked.</span></span> [!INCLUDE[netfx_current_short](../../../../includes/netfx-current-short-md.md)]<span data-ttu-id="ea1fd-107"> 通过提供 <xref:System.Activities.Statements.CancellationScope> 活动帮助您执行此操作。 </span><span class="sxs-lookup"><span data-stu-id="ea1fd-107"> helps you with this by providing a <xref:System.Activities.Statements.CancellationScope> activity.</span></span>  
  
 <span data-ttu-id="ea1fd-108">可以从活动内或活动的父级触发取消。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-108">Cancellation can be triggered either from within an activity or from the activity's parent.</span></span>  <span data-ttu-id="ea1fd-109">按照父活动（如 <xref:System.Activities.Statements.Sequence>、<xref:System.Activities.Statements.Parallel>、<xref:System.Activities.Statements.Flowchart> 或自定义复合活动）来计划其子活动。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-109">Child activities are scheduled by their parent activity (such as a <xref:System.Activities.Statements.Sequence>, <xref:System.Activities.Statements.Parallel>, <xref:System.Activities.Statements.Flowchart>, or a custom composite activity).</span></span>  <span data-ttu-id="ea1fd-110">父活动可以出于任何原因取消子活动。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-110">The parent activity can cancel child activities for any reason.</span></span>  <span data-ttu-id="ea1fd-111">例如，只要带三个子分支的 <xref:System.Activities.Statements.Parallel> 活动完成一个分支且 <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> 表达式的计算结果为 `true`，该活动就会取消剩余子分支。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-111">For example, a <xref:System.Activities.Statements.Parallel> activity with three child branches will cancel the remaining child branches whenever it completes a branch and the <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> expression evaluates to `true`.</span></span> <span data-ttu-id="ea1fd-112">宿主应用程序可以调用 <xref:System.Activities.WorkflowApplication.Cancel%2A> 来外部取消工作流。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-112">The workflow can also be canceled externally by the host application by calling <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span></span>  
  
 <span data-ttu-id="ea1fd-113">若要使用 <xref:System.Activities.Statements.CancellationScope> 活动，请将需要取消的工作置于 <xref:System.Activities.Statements.CancellationScope.Body%2A> 属性中，并将取消后执行的工作置于 <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> 属性中。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-113">To use the <xref:System.Activities.Statements.CancellationScope> activity, put the work that needs to be canceled into the <xref:System.Activities.Statements.CancellationScope.Body%2A> property, and put the work that is performed after cancellation into the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> property.</span></span>  
  
 <span data-ttu-id="ea1fd-114">此示例演示如何从活动自身内部取消活动。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-114">This sample demonstrates cancelling an activity from within the activity itself.</span></span>  
  
 <span data-ttu-id="ea1fd-115">此示例用来演示 <xref:System.Activities.Statements.CancellationScope> 活动的场景是：一个客户需要尽快购买到迈阿密的机票。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-115">The scenario that the sample uses to demonstrate the <xref:System.Activities.Statements.CancellationScope> activity is a client wanting to buy a ticket to Miami as soon as possible.</span></span> <span data-ttu-id="ea1fd-116">有两家旅行社希望承接此业务。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-116">There are two travel agencies that want the business.</span></span> <span data-ttu-id="ea1fd-117">示例使用 <xref:System.Activities.Statements.CancellationScope> 活动中的两个 <xref:System.Activities.Statements.Parallel> 对此业务逻辑进行建模。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-117">The sample uses two <xref:System.Activities.Statements.CancellationScope> within a <xref:System.Activities.Statements.Parallel> activity to model this business logic.</span></span> <span data-ttu-id="ea1fd-118"><xref:System.Activities.Statements.Parallel.CompletionCondition%2A> 活动的 <xref:System.Activities.Statements.Parallel> 设置为 `true`；由于在完成任何分支后将检查 <xref:System.Activities.Statements.Parallel.CompletionCondition%2A>，因此将导致剩余分支在第一个分支完成后被取消。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-118">The <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> of the <xref:System.Activities.Statements.Parallel> activity is set to `true`; since the <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> is checked after any branch completes, this will cause the remaining branch to be canceled after the first branch completes.</span></span> <span data-ttu-id="ea1fd-119">客户端应用程序会同时请求这两家旅行社购买机票，一旦第一家旅行社确认已购得机票，应用程序将取消对另一家旅行社所下的订单。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-119">The client application asks both agencies to buy the ticket, and when the first one confirms that the ticket has been bought, the application cancels the order at the other agency.</span></span>  
  
## <a name="to-use-this-sample"></a><span data-ttu-id="ea1fd-120">使用此示例</span><span class="sxs-lookup"><span data-stu-id="ea1fd-120">To use this sample</span></span>  
  
1.  <span data-ttu-id="ea1fd-121">使用 [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)] 打开 CancelationScopeXAML.sln 解决方案文件。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-121">Using [!INCLUDE[vs2010](../../../../includes/vs2010-md.md)], open the CancelationScopeXAML.sln solution file.</span></span>  
  
2.  <span data-ttu-id="ea1fd-122">要生成解决方案，按 Ctrl+Shift+B。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-122">To build the solution, press CTRL+SHIFT+B.</span></span>  
  
3.  <span data-ttu-id="ea1fd-123">若要运行解决方案，请按 Ctrl+F5。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-123">To run the solution, press CTRL+F5.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="ea1fd-124">您的计算机上可能已安装这些示例。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-124">The samples may already be installed on your machine.</span></span> <span data-ttu-id="ea1fd-125">在继续操作之前，请先检查以下（默认）目录：</span><span class="sxs-lookup"><span data-stu-id="ea1fd-125">Check for the following (default) directory before continuing.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples`  
>   
>  <span data-ttu-id="ea1fd-126">如果此目录不存在，请转到[Windows Communication Foundation (WCF) 和.NET Framework 4 的 Windows Workflow Foundation (WF) 示例](https://go.microsoft.com/fwlink/?LinkId=150780)若要下载所有 Windows Communication Foundation (WCF) 和[!INCLUDE[wf1](../../../../includes/wf1-md.md)]示例。</span><span class="sxs-lookup"><span data-stu-id="ea1fd-126">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) to download all Windows Communication Foundation (WCF) and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="ea1fd-127">此示例位于以下目录：</span><span class="sxs-lookup"><span data-stu-id="ea1fd-127">This sample is located in the following directory.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples\WF\Basic\Built-InActivities\CancellationScope`