---
title: "Direct3D9 和 WPF 互操作性的性能注意事项"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-wpf
ms.tgt_pltfrm: 
ms.topic: article
helpviewer_keywords:
- WPF [WPF], Direct3D9 interop performance
- Direct3D9 [WPF interoperability], performance
ms.assetid: ea8baf91-12fe-4b44-ac4d-477110ab14dd
caps.latest.revision: "19"
author: dotnet-bot
ms.author: dotnetcontent
manager: wpickett
ms.workload: dotnet
ms.openlocfilehash: 8142125eae26b15f12652d28fdf0c34f19d49c4e
ms.sourcegitcommit: 16186c34a957fdd52e5db7294f291f7530ac9d24
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/22/2017
---
# <a name="performance-considerations-for-direct3d9-and-wpf-interoperability"></a><span data-ttu-id="4f069-102">Direct3D9 和 WPF 互操作性的性能注意事项</span><span class="sxs-lookup"><span data-stu-id="4f069-102">Performance Considerations for Direct3D9 and WPF Interoperability</span></span>
<span data-ttu-id="4f069-103">你可以通过使用承载 Direct3D9 内容<xref:System.Windows.Interop.D3DImage>类。</span><span class="sxs-lookup"><span data-stu-id="4f069-103">You can host Direct3D9 content by using the <xref:System.Windows.Interop.D3DImage> class.</span></span> <span data-ttu-id="4f069-104">承载 Direct3D9 内容可能会影响你的应用程序的性能。</span><span class="sxs-lookup"><span data-stu-id="4f069-104">Hosting Direct3D9 content can affect the performance of your application.</span></span> <span data-ttu-id="4f069-105">本主题介绍在承载 Windows Presentation Foundation (WPF) 应用程序中的 Direct3D9 内容时优化性能的最佳做法。</span><span class="sxs-lookup"><span data-stu-id="4f069-105">This topic describes best practices to optimize performance when hosting Direct3D9 content in a Windows Presentation Foundation (WPF) application.</span></span> <span data-ttu-id="4f069-106">这些最佳实践包括如何使用<xref:System.Windows.Interop.D3DImage>以及当你使用的 Windows Vista、 Windows XP 中，且多监视器显示最佳实践。</span><span class="sxs-lookup"><span data-stu-id="4f069-106">These best practices include how to use <xref:System.Windows.Interop.D3DImage> and best practices when you are using Windows Vista, Windows XP, and multi-monitor displays.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="4f069-107">有关演示这些最佳做法的代码示例，请参阅[WPF 和 Direct3D9 间的互操作](../../../../docs/framework/wpf/advanced/wpf-and-direct3d9-interoperation.md)。</span><span class="sxs-lookup"><span data-stu-id="4f069-107">For code examples that demonstrate these best practices, see [WPF and Direct3D9 Interoperation](../../../../docs/framework/wpf/advanced/wpf-and-direct3d9-interoperation.md).</span></span>  
  
## <a name="use-d3dimage-sparingly"></a><span data-ttu-id="4f069-108">应谨慎使用 D3DImage</span><span class="sxs-lookup"><span data-stu-id="4f069-108">Use D3DImage Sparingly</span></span>  
 <span data-ttu-id="4f069-109">在承载 Direct3D9 内容<xref:System.Windows.Interop.D3DImage>实例不呈现为快速如下所示纯的 Direct3D 应用程序。</span><span class="sxs-lookup"><span data-stu-id="4f069-109">Direct3D9 content hosted in a <xref:System.Windows.Interop.D3DImage> instance does not render as fast as in a pure Direct3D application.</span></span> <span data-ttu-id="4f069-110">复制图面和刷新命令缓冲区可能成本高昂的操作。</span><span class="sxs-lookup"><span data-stu-id="4f069-110">Copying the surface and flushing the command buffer can be costly operations.</span></span> <span data-ttu-id="4f069-111">数字的形式<xref:System.Windows.Interop.D3DImage>实例将提高，多个刷新发生，并且性能下降。</span><span class="sxs-lookup"><span data-stu-id="4f069-111">As the number of <xref:System.Windows.Interop.D3DImage> instances increases, more flushing occurs, and performance degrades.</span></span> <span data-ttu-id="4f069-112">因此，应使用<xref:System.Windows.Interop.D3DImage>谨慎。</span><span class="sxs-lookup"><span data-stu-id="4f069-112">Therefore, you should use <xref:System.Windows.Interop.D3DImage> sparingly.</span></span>  
  
## <a name="best-practices-on-windows-vista"></a><span data-ttu-id="4f069-113">在 Windows Vista 上的最佳做法</span><span class="sxs-lookup"><span data-stu-id="4f069-113">Best Practices on Windows Vista</span></span>  
 <span data-ttu-id="4f069-114">对于具有配置为使用 Windows 显示驱动程序模型 (WDDM) 显示在 Windows Vista 上获得最佳性能上, 创建 Direct3D9 面`IDirect3DDevice9Ex`设备。</span><span class="sxs-lookup"><span data-stu-id="4f069-114">For best performance on Windows Vista with a display that is configured to use the Windows Display Driver Model (WDDM), create your Direct3D9 surface on an `IDirect3DDevice9Ex` device.</span></span> <span data-ttu-id="4f069-115">这使图面共享。</span><span class="sxs-lookup"><span data-stu-id="4f069-115">This enables surface sharing.</span></span> <span data-ttu-id="4f069-116">视频卡必须支持`D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES`和`D3DCAPS2_CANSHARERESOURCE`在 Windows Vista 上的驱动程序功能。</span><span class="sxs-lookup"><span data-stu-id="4f069-116">The video card must support the `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` and `D3DCAPS2_CANSHARERESOURCE` driver capabilities on Windows Vista.</span></span> <span data-ttu-id="4f069-117">任何其他设置会导致面复制通过软件，这将显著降低性能。</span><span class="sxs-lookup"><span data-stu-id="4f069-117">Any other settings cause the surface to be copied through software, which reduces performance significantly.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="4f069-118">如果 Windows Vista 具有配置为使用 Windows XP 显示驱动程序模型 (XDDM) 显示，面将总是复制通过软件，而不考虑设置。</span><span class="sxs-lookup"><span data-stu-id="4f069-118">If Windows Vista has a display that is configured to use the Windows XP Display Driver Model (XDDM), the surface is always copied through software, regardless of settings.</span></span> <span data-ttu-id="4f069-119">正确的设置和视频卡，你将在 Windows Vista 上看到更好的性能时因为图面副本执行硬件中使用的 WDDM。</span><span class="sxs-lookup"><span data-stu-id="4f069-119">With the proper settings and video card, you will see better performance on Windows Vista when you use the WDDM because surface copies are performed in hardware.</span></span>  
  
## <a name="best-practices-on-windows-xp"></a><span data-ttu-id="4f069-120">在 Windows XP 上的最佳做法</span><span class="sxs-lookup"><span data-stu-id="4f069-120">Best Practices on Windows XP</span></span>  
 <span data-ttu-id="4f069-121">为了获得最佳性能，在 Windows XP 中，使用 Windows XP 显示驱动程序模型 (XDDM)，创建正确的行为的可锁定面时`IDirect3DSurface9::GetDC`调用方法。</span><span class="sxs-lookup"><span data-stu-id="4f069-121">For best performance on Windows XP, which uses the Windows XP Display Driver Model (XDDM), create a lockable surface that behaves correctly when the `IDirect3DSurface9::GetDC` method is called.</span></span> <span data-ttu-id="4f069-122">在内部，`BitBlt`方法硬件中的设备之间传输图面。</span><span class="sxs-lookup"><span data-stu-id="4f069-122">Internally, the `BitBlt` method transfers the surface across devices in hardware.</span></span> <span data-ttu-id="4f069-123">`GetDC`方法始终适用 XRGB 图面上。</span><span class="sxs-lookup"><span data-stu-id="4f069-123">The `GetDC` method always works on XRGB surfaces.</span></span> <span data-ttu-id="4f069-124">但是，如果客户端计算机正在运行 Windows XP SP3 或 SP2，并且客户端还具有分层窗口功能的修补程序，此方法仅适用于 ARGB 图面。</span><span class="sxs-lookup"><span data-stu-id="4f069-124">However, if the client computer is running Windows XP with SP3 or SP2, and if the client also has the hotfix for the layered-window feature, this method only works on ARGB surfaces.</span></span> <span data-ttu-id="4f069-125">视频卡必须支持`D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES`驱动程序功能。</span><span class="sxs-lookup"><span data-stu-id="4f069-125">The video card must support the `D3DDEVCAPS2_CAN_STRETCHRECT_FROM_TEXTURES` driver capability.</span></span>  
  
 <span data-ttu-id="4f069-126">16 位桌面显示深度可以显著降低性能。</span><span class="sxs-lookup"><span data-stu-id="4f069-126">A 16-bit desktop display depth can significantly reduce performance.</span></span> <span data-ttu-id="4f069-127">建议的 32 位桌面。</span><span class="sxs-lookup"><span data-stu-id="4f069-127">A 32-bit desktop is recommended.</span></span>  
  
 <span data-ttu-id="4f069-128">如果你要开发用于 Windows Vista 和 Windows XP，则测试 Windows XP 上的性能。</span><span class="sxs-lookup"><span data-stu-id="4f069-128">If you are developing for Windows Vista and Windows XP, test the performance on Windows XP.</span></span> <span data-ttu-id="4f069-129">在 Windows XP 上的视频内存不足是一个问题。</span><span class="sxs-lookup"><span data-stu-id="4f069-129">Running out of video memory on Windows XP is a concern.</span></span> <span data-ttu-id="4f069-130">此外， <xref:System.Windows.Interop.D3DImage> Windows XP 上使用更多的视频内存和带宽比 Windows Vista WDDM，由于所需的额外视频内存复制。</span><span class="sxs-lookup"><span data-stu-id="4f069-130">In addition, <xref:System.Windows.Interop.D3DImage> on Windows XP uses more video memory and bandwidth than Windows Vista WDDM, due to a necessary extra video memory copy.</span></span> <span data-ttu-id="4f069-131">因此，你可能会更糟的是在比在 Windows Vista 上的 Windows XP 上为视频的相同硬件的性能。</span><span class="sxs-lookup"><span data-stu-id="4f069-131">Therefore, you can expect performance to be worse on Windows XP than on Windows Vista for the same video hardware.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="4f069-132">XDDM 是适用于 Windows XP 和 Windows Vista;但是，WDDM 是仅在 Windows Vista 上可用。</span><span class="sxs-lookup"><span data-stu-id="4f069-132">XDDM is available on both Windows XP and Windows Vista; however, WDDM is available only on Windows Vista.</span></span>  
  
## <a name="general-best-practices"></a><span data-ttu-id="4f069-133">常规最佳做法</span><span class="sxs-lookup"><span data-stu-id="4f069-133">General Best Practices</span></span>  
 <span data-ttu-id="4f069-134">创建设备时，使用`D3DCREATE_MULTITHREADED`创建标志。</span><span class="sxs-lookup"><span data-stu-id="4f069-134">When you create the device, use the `D3DCREATE_MULTITHREADED` creation flag.</span></span> <span data-ttu-id="4f069-135">这会降低性能，但 WPF 呈现系统从另一个线程在此设备上调用方法。</span><span class="sxs-lookup"><span data-stu-id="4f069-135">This reduces performance, but the WPF rendering system calls methods on this device from another thread.</span></span> <span data-ttu-id="4f069-136">因此，没有两个线程同时访问设备，则请确保正确，随后锁定的协议。</span><span class="sxs-lookup"><span data-stu-id="4f069-136">Be sure to follow the locking protocol correctly, so that no two threads access the device at the same time.</span></span>  
  
 <span data-ttu-id="4f069-137">如果 WPF 托管线程上执行呈现，则强烈建议你创建带有设备`D3DCREATE_FPU_PRESERVE`创建标志。</span><span class="sxs-lookup"><span data-stu-id="4f069-137">If your rendering is performed on a WPF managed thread, it is strongly recommended that you create the device with the `D3DCREATE_FPU_PRESERVE` creation flag.</span></span> <span data-ttu-id="4f069-138">没有此设置，D3D 呈现可以减少 WPF 双精度运算的准确性，并引发呈现问题。</span><span class="sxs-lookup"><span data-stu-id="4f069-138">Without this setting, the D3D rendering can reduce the accuracy of WPF double-precision operations and introduce rendering issues.</span></span>  
  
 <span data-ttu-id="4f069-139">平铺<xref:System.Windows.Interop.D3DImage>除非磁贴没有硬件支持非 pow2 面，或者你磁贴并快速，<xref:System.Windows.Media.DrawingBrush>或<xref:System.Windows.Media.VisualBrush>包含<xref:System.Windows.Interop.D3DImage>。</span><span class="sxs-lookup"><span data-stu-id="4f069-139">Tiling a <xref:System.Windows.Interop.D3DImage> is fast, unless you tile a non-pow2 surface without hardware support, or if you tile a <xref:System.Windows.Media.DrawingBrush> or <xref:System.Windows.Media.VisualBrush> that contains a <xref:System.Windows.Interop.D3DImage>.</span></span>  
  
## <a name="best-practices-for-multi-monitor-displays"></a><span data-ttu-id="4f069-140">多监视器显示的最佳实践</span><span class="sxs-lookup"><span data-stu-id="4f069-140">Best Practices for Multi-Monitor Displays</span></span>  
 <span data-ttu-id="4f069-141">如果你使用的具有多个监视器的计算机，你应遵循前面所述的最佳做法。</span><span class="sxs-lookup"><span data-stu-id="4f069-141">If you are using a computer that has multiple monitors, you should follow the previously described best practices.</span></span> <span data-ttu-id="4f069-142">也有一些额外的性能注意事项多监视器配置。</span><span class="sxs-lookup"><span data-stu-id="4f069-142">There are also some additional performance considerations for a multi-monitor configuration.</span></span>  
  
 <span data-ttu-id="4f069-143">创建后台缓冲区时，它将创建上特定设备和适配器，但 WPF 可能会显示任何适配器上的前台缓冲区。</span><span class="sxs-lookup"><span data-stu-id="4f069-143">When you create the back buffer, it is created on a specific device and adapter, but WPF may display the front buffer on any adapter.</span></span> <span data-ttu-id="4f069-144">在适配器，以更新前台缓冲区之间复制会产生大量费用。</span><span class="sxs-lookup"><span data-stu-id="4f069-144">Copying across adapters to update the front buffer can be very expensive.</span></span> <span data-ttu-id="4f069-145">在 Windows Vista 上，配置为与多个视频卡以及使用的 WDDM`IDirect3DDevice9Ex`设备，如果前台缓冲区位于其他适配器，但不失为这相同的视频卡上，没有任何性能损失。</span><span class="sxs-lookup"><span data-stu-id="4f069-145">On Windows Vista that is configured to use the WDDM with multiple video cards and with an `IDirect3DDevice9Ex` device, if the front buffer is on a different adapter but still the same video card, there is no performance penalty.</span></span> <span data-ttu-id="4f069-146">但是，在 Windows XP 和具有多个视频卡 XDDM，没有对显著的性能产生负面影响时前台缓冲区显示在不同于后台缓冲区适配器上。</span><span class="sxs-lookup"><span data-stu-id="4f069-146">However, on Windows XP and the XDDM with multiple video cards, there is a significant performance penalty when the front buffer is displayed on a different adapter than the back buffer.</span></span> <span data-ttu-id="4f069-147">有关详细信息，请参阅[WPF 和 Direct3D9 间的互操作](../../../../docs/framework/wpf/advanced/wpf-and-direct3d9-interoperation.md)。</span><span class="sxs-lookup"><span data-stu-id="4f069-147">For more information, see [WPF and Direct3D9 Interoperation](../../../../docs/framework/wpf/advanced/wpf-and-direct3d9-interoperation.md).</span></span>  
  
## <a name="performance-summary"></a><span data-ttu-id="4f069-148">性能摘要</span><span class="sxs-lookup"><span data-stu-id="4f069-148">Performance Summary</span></span>  
 <span data-ttu-id="4f069-149">下表显示了前台缓冲区更新的操作系统、 像素格式和图面可锁定性的函数的性能。</span><span class="sxs-lookup"><span data-stu-id="4f069-149">The following table shows performance of the front buffer update as a function of operating system, pixel format, and surface lockability.</span></span> <span data-ttu-id="4f069-150">前台缓冲区和后台缓冲区被假定为同一适配器上。</span><span class="sxs-lookup"><span data-stu-id="4f069-150">The front buffer and back buffer are assumed to be on the same adapter.</span></span> <span data-ttu-id="4f069-151">具体取决于适配器配置中，硬件更新是通常比软件更新快得多。</span><span class="sxs-lookup"><span data-stu-id="4f069-151">Depending on the adapter configuration, hardware updates are generally much faster than software updates.</span></span>  
  
|<span data-ttu-id="4f069-152">图面像素格式</span><span class="sxs-lookup"><span data-stu-id="4f069-152">Surface pixel format</span></span>|<span data-ttu-id="4f069-153">Windows Vista、 WDDM 和 9Ex</span><span class="sxs-lookup"><span data-stu-id="4f069-153">Windows Vista, WDDM and 9Ex</span></span>|<span data-ttu-id="4f069-154">其他 Windows Vista 配置</span><span class="sxs-lookup"><span data-stu-id="4f069-154">Other Windows Vista configurations</span></span>|<span data-ttu-id="4f069-155">Windows XP SP3 或修补程序带 SP2</span><span class="sxs-lookup"><span data-stu-id="4f069-155">Windows XP SP3 or SP2 w/ hotfix</span></span>|<span data-ttu-id="4f069-156">Windows XP SP2</span><span class="sxs-lookup"><span data-stu-id="4f069-156">Windows XP SP2</span></span>|  
|--------------------------|---------------------------------|----------------------------------------|--------------------------------------|--------------------|  
|<span data-ttu-id="4f069-157">D3DFMT_X8R8G8B8 （不可锁定）</span><span class="sxs-lookup"><span data-stu-id="4f069-157">D3DFMT_X8R8G8B8 (not lockable)</span></span>|<span data-ttu-id="4f069-158">**硬件更新**</span><span class="sxs-lookup"><span data-stu-id="4f069-158">**Hardware Update**</span></span>|<span data-ttu-id="4f069-159">软件更新</span><span class="sxs-lookup"><span data-stu-id="4f069-159">Software Update</span></span>|<span data-ttu-id="4f069-160">软件更新</span><span class="sxs-lookup"><span data-stu-id="4f069-160">Software Update</span></span>|<span data-ttu-id="4f069-161">软件更新</span><span class="sxs-lookup"><span data-stu-id="4f069-161">Software Update</span></span>|  
|<span data-ttu-id="4f069-162">D3DFMT_X8R8G8B8 （可锁定）</span><span class="sxs-lookup"><span data-stu-id="4f069-162">D3DFMT_X8R8G8B8 (lockable)</span></span>|<span data-ttu-id="4f069-163">**硬件更新**</span><span class="sxs-lookup"><span data-stu-id="4f069-163">**Hardware Update**</span></span>|<span data-ttu-id="4f069-164">软件更新</span><span class="sxs-lookup"><span data-stu-id="4f069-164">Software Update</span></span>|<span data-ttu-id="4f069-165">**硬件更新**</span><span class="sxs-lookup"><span data-stu-id="4f069-165">**Hardware Update**</span></span>|<span data-ttu-id="4f069-166">**硬件更新**</span><span class="sxs-lookup"><span data-stu-id="4f069-166">**Hardware Update**</span></span>|  
|<span data-ttu-id="4f069-167">D3DFMT_A8R8G8B8 （不可锁定）</span><span class="sxs-lookup"><span data-stu-id="4f069-167">D3DFMT_A8R8G8B8 (not lockable)</span></span>|<span data-ttu-id="4f069-168">**硬件更新**</span><span class="sxs-lookup"><span data-stu-id="4f069-168">**Hardware Update**</span></span>|<span data-ttu-id="4f069-169">软件更新</span><span class="sxs-lookup"><span data-stu-id="4f069-169">Software Update</span></span>|<span data-ttu-id="4f069-170">软件更新</span><span class="sxs-lookup"><span data-stu-id="4f069-170">Software Update</span></span>|<span data-ttu-id="4f069-171">软件更新</span><span class="sxs-lookup"><span data-stu-id="4f069-171">Software Update</span></span>|  
|<span data-ttu-id="4f069-172">D3DFMT_A8R8G8B8 （可锁定）</span><span class="sxs-lookup"><span data-stu-id="4f069-172">D3DFMT_A8R8G8B8 (lockable)</span></span>|<span data-ttu-id="4f069-173">**硬件更新**</span><span class="sxs-lookup"><span data-stu-id="4f069-173">**Hardware Update**</span></span>|<span data-ttu-id="4f069-174">软件更新</span><span class="sxs-lookup"><span data-stu-id="4f069-174">Software Update</span></span>|<span data-ttu-id="4f069-175">**硬件更新**</span><span class="sxs-lookup"><span data-stu-id="4f069-175">**Hardware Update**</span></span>|<span data-ttu-id="4f069-176">软件更新</span><span class="sxs-lookup"><span data-stu-id="4f069-176">Software Update</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="4f069-177">请参阅</span><span class="sxs-lookup"><span data-stu-id="4f069-177">See Also</span></span>  
 <xref:System.Windows.Interop.D3DImage>  
 [<span data-ttu-id="4f069-178">WPF 和 Direct3D9 互操作</span><span class="sxs-lookup"><span data-stu-id="4f069-178">WPF and Direct3D9 Interoperation</span></span>](../../../../docs/framework/wpf/advanced/wpf-and-direct3d9-interoperation.md)  
 [<span data-ttu-id="4f069-179">演练：创建在 WPF 中托管的 Direct3D9 内容</span><span class="sxs-lookup"><span data-stu-id="4f069-179">Walkthrough: Creating Direct3D9 Content for Hosting in WPF</span></span>](../../../../docs/framework/wpf/advanced/walkthrough-creating-direct3d9-content-for-hosting-in-wpf.md)  
 [<span data-ttu-id="4f069-180">演练：在 WPF 中托管 Direct3D9 内容</span><span class="sxs-lookup"><span data-stu-id="4f069-180">Walkthrough: Hosting Direct3D9 Content in WPF</span></span>](../../../../docs/framework/wpf/advanced/walkthrough-hosting-direct3d9-content-in-wpf.md)
